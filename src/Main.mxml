<?xml version="1.0" encoding="utf-8"?>
<s:WindowedApplication xmlns:fx="http://ns.adobe.com/mxml/2009"
					   xmlns:s="library://ns.adobe.com/flex/spark"
					   xmlns:mx="library://ns.adobe.com/flex/mx"
					   width="900" height="400"
					   creationComplete="windowedapplication1_creationCompleteHandler(event)">
	<fx:Script>
		<![CDATA[
			import com.adobe.serializers.utility.TypeUtility;
			
			import mx.collections.ArrayCollection;
			import mx.collections.Sort;
			import mx.collections.SortField;
			import mx.controls.Alert;
			import mx.events.FlexEvent;
			import mx.rpc.events.FaultEvent;
			import mx.rpc.events.ResultEvent;
			
			import services.eventbrite.Eventbrite;
			
			private var app_key:String = "Y2Y1MjkwODY3NmYz";
			private var user_key:String = "12426633151316652142";
			private var eventbrite:Eventbrite;
			[Bindable] private var events:ArrayCollection;
			[Bindable] private var attendees:ArrayCollection;
			
			protected function user_list_events():void
			{
				user_list_eventsResult.token = eventbrite.userListEvents();
			}
			

			protected function getEvents():void
			{
				eventbrite.removeEventListener(ResultEvent.RESULT,getAttendeesListResult);
				eventbrite.addEventListener(ResultEvent.RESULT,getEventListResult);
				user_list_events();
			}


			protected function windowedapplication1_creationCompleteHandler(event:FlexEvent):void
			{
				list.addEventListener(EventbriteEvent.VIEW_EVENT,getEvent);
				
				eventbrite = new Eventbrite(app_key,user_key);
				eventbrite.showBusyCursor = true;
				eventbrite.addEventListener(FaultEvent.FAULT,function(event:FaultEvent):void{
					Alert.show(event.fault.faultString + '\n' + event.fault.faultDetail);
				});
				
				getEvents();
			}
			
			protected function getEventListResult(event:ResultEvent):void{
				var collection:ArrayCollection = event.result.events;
				var sortField:SortField = new SortField();
				var sort:Sort = new Sort();
				sort.compareFunction = compare;
				collection.sort = sort;
				collection.refresh();
				events = collection;
			}
			
			protected function compare(a:Object, b:Object, fields:Array = null):int{
				var result:int = 0;
				var i:int = 0;
				var len:int = 1;
				var propName:String;
				while (result == 0 && (i < len))
				{
					result = compareValues(b.event.id, a.event.id);
					i++;
				}
				return result;
			}
			
			protected function compareValues(a:Object, b:Object):int
			{
				if (a == null && b == null)
					return 0;
				if (a == null)
					return 1;
				if (b == null)
					return -1;
				if (a < b)
					return -1;
				if (a > b)
					return 1;
				return 0;
			}
			
			protected function getEvent(event:EventbriteEvent):void{
				eventbrite.removeEventListener(ResultEvent.RESULT,getEventListResult);
				eventbrite.addEventListener(ResultEvent.RESULT,getAttendeesListResult);
				
				eventbrite.eventAttendeeList(event.event_id.toString());
			}
			
			protected function getAttendeesListResult(event:ResultEvent):void{
				attendees = event.result.attendees;
			}

		]]>
	</fx:Script>
	<fx:Declarations>
		<s:CallResponder id="user_list_eventsResult"/>
		<!--eventbrite:Eventbrite id="eventbrite"
							   fault="Alert.show(event.fault.faultString + '\n' + event.fault.faultDetail)"
							   showBusyCursor="true"/-->
		<!-- Place non-visual elements (e.g., services, value objects) here -->
	</fx:Declarations>
	
	<s:HGroup x="0" y="0" width="100%" height="100%">
		<s:VGroup width="100%" height="100%">
			<s:List id="list" width="100%" height="100%" itemRenderer="EventsItemRenderer" dataProvider="{events}" alternatingItemColors="{[0xffffff,0xCCCCCC]}">
				<!--s:AsyncListView list="{TypeUtility.convertToCollection(user_list_eventsResult.lastResult.events)}" /-->
			</s:List>
			<s:HGroup width="100%" horizontalAlign="right">
				<s:Button label="Refresh" click="getEvents()"/>
			</s:HGroup>
		</s:VGroup>
		<s:VGroup width="100%" height="100%">
			<s:List id="attendeeList" width="100%" height="100%" dataProvider="{attendees}"></s:List>
			<s:HGroup width="100%" horizontalAlign="right">
				<s:Button label="Button"/>
			</s:HGroup>
			
		</s:VGroup>
	</s:HGroup>
</s:WindowedApplication>
